<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Sarathi Visions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Playfair+Display:wght@700;800;900&display=swap');
        * { font-family: 'Poppins', sans-serif; }
        .glass-effect { background: rgba(10,15,35,0.6); backdrop-filter: blur(10px); border:1px solid rgba(59,130,246,0.12); }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Admin Panel — Sarathi Visions</h1>
            <div>
                <a href="index.html" class="text-sm text-slate-300 hover:text-blue-300">Back to site</a>
            </div>
        </header>

        <!-- Login -->
        <div id="loginBox" class="glass-effect p-6 rounded-lg max-w-md mx-auto">
            <h2 class="text-lg font-semibold mb-3">Administrator Login</h2>
            <p class="text-slate-400 text-sm mb-4">Enter administrator password to access employee management.</p>
            <div class="space-y-3">
                <input id="adminPassword" type="password" placeholder="Password" class="w-full form-input p-3 rounded-md bg-slate-900 border border-slate-700" />
                <div class="flex justify-end">
                    <button id="loginBtn" class="px-4 py-2 bg-blue-600 rounded-md hover:bg-blue-500">Login</button>
                </div>
            </div>
            <p class="text-xs text-slate-500 mt-3">Default demo password: <strong>admin123</strong></p>
        </div>

        <!-- Admin UI -->
        <div id="adminUI" class="hidden">
            <section class="glass-effect p-6 rounded-lg mb-6">
                <h2 class="font-semibold mb-3">Add / Import Employees</h2>
                <form id="employeeForm" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input id="e_name" placeholder="Full name" class="form-input p-2 rounded" />
                    <input id="e_mobile" placeholder="Mobile" class="form-input p-2 rounded" />
                    <input id="e_email" placeholder="Email" class="form-input p-2 rounded" />
                    <input id="e_state" placeholder="State" class="form-input p-2 rounded" />
                    <input id="e_district" placeholder="District" class="form-input p-2 rounded" />
                    <input id="e_taluka" placeholder="Taluka" class="form-input p-2 rounded" />
                    <input id="e_village" placeholder="Village" class="form-input p-2 rounded" />
                    <input id="e_role" placeholder="Role (e.g., Field Worker)" class="form-input p-2 rounded" />
                    <div class="flex items-center space-x-2">
                        <button id="addEmployeeBtn" class="px-4 py-2 bg-green-600 rounded hover:bg-green-500">Add Employee</button>
                        <button id="importSampleBtn" type="button" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">Import Sample</button>
                        <button id="exportBtn" type="button" class="px-4 py-2 bg-slate-700 rounded hover:bg-slate-600">Export JSON</button>
                    </div>
                </form>
            </section>

            <section class="glass-effect p-6 rounded-lg mb-6">
                <h2 class="font-semibold mb-3">Filters</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <select id="filterState" class="form-select p-2 rounded" onchange="onFilterChange()"><option value="">All States</option></select>
                    <select id="filterDistrict" class="form-select p-2 rounded" onchange="onFilterChange()"><option value="">All Districts</option></select>
                    <select id="filterTaluka" class="form-select p-2 rounded" onchange="onFilterChange()"><option value="">All Talukas</option></select>
                    <select id="filterVillage" class="form-select p-2 rounded" onchange="onFilterChange()"><option value="">All Villages</option></select>
                </div>
                <div class="mt-3">
                    <button id="resetFilters" class="px-3 py-1 bg-slate-700 rounded" onclick="resetFilters()">Reset</button>
                </div>
            </section>

            <section class="glass-effect p-6 rounded-lg">
                <h2 class="font-semibold mb-3">Employees</h2>
                <div id="employeesContainer" class="space-y-4"></div>
            </section>
        </div>
    </div>

    <script>
        // Admin script with optional server integration.
        const DEMO_PASSWORD = 'admin123';
        const EMP_KEY = 'sv_employees_v1';
        const TOKEN_KEY = 'sv_admin_token';
        // Change if your server runs on a different host/port
        const API_BASE = 'http://localhost:3000';

        // Helper: get stored token
        function getToken(){ return localStorage.getItem(TOKEN_KEY); }

        async function apiFetch(path, opts={}){
            const token = getToken();
            const headers = opts.headers || {};
            headers['Accept'] = 'application/json';
            if (token) headers['Authorization'] = 'Bearer '+token;
            opts.headers = headers;
            const res = await fetch(API_BASE + path, opts);
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || res.statusText);
            }
            return res.json();
        }

        // Login: try server first; if server not reachable or login fails, fall back to demo local login
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const pw = document.getElementById('adminPassword').value.trim();
            // try server
            try {
                const r = await fetch(API_BASE + '/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password: pw }) });
                if (r.ok) {
                    const data = await r.json();
                    localStorage.setItem(TOKEN_KEY, data.token);
                    showAdminUI();
                    return;
                }
            } catch(e){ /* server not reachable or error */ }

            // fallback demo
            if (pw === DEMO_PASSWORD) {
                showAdminUI();
                return;
            }
            alert('Incorrect password or server not reachable');
        });

        function showAdminUI(){
            document.getElementById('loginBox').classList.add('hidden');
            document.getElementById('adminUI').classList.remove('hidden');
            initAdmin();
        }

        // Load employees - server if token present else local
        async function loadEmployees(){
            const token = getToken();
            if (token) {
                try { return await apiFetch('/api/employees'); } catch(e){ console.error('API load error', e); return []; }
            }
            try { const raw = localStorage.getItem(EMP_KEY); return raw?JSON.parse(raw):[]; } catch(e){ return []; }
        }

        async function saveEmployees(list){
            const token = getToken();
            if (token) {
                // simple approach: clear table and re-import all (for demo)
                await apiFetch('/api/employees/import', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(list) });
                return;
            }
            localStorage.setItem(EMP_KEY, JSON.stringify(list));
        }

        function clearForm(){ ['e_name','e_mobile','e_email','e_state','e_district','e_taluka','e_village','e_role'].forEach(id=>document.getElementById(id).value=''); }

        async function initAdmin(){
            await renderFilters();
            await renderEmployees();
            document.getElementById('addEmployeeBtn').addEventListener('click', onAddEmployee);
            document.getElementById('importSampleBtn').addEventListener('click', importSample);
            document.getElementById('exportBtn').addEventListener('click', exportEmployees);

            // add CSV import input dynamically
            if (!document.getElementById('csvInput')){
                const csvBtn = document.createElement('input');
                csvBtn.type = 'file'; csvBtn.accept = '.csv'; csvBtn.id='csvInput'; csvBtn.className='ml-2';
                csvBtn.addEventListener('change', async (ev)=>{
                    const file = ev.target.files[0]; if(!file) return;
                    const token = getToken();
                    if (token) {
                        const fd = new FormData(); fd.append('file', file);
                        try { const res = await fetch(API_BASE + '/api/employees/import-csv', { method:'POST', headers:{ 'Authorization':'Bearer '+token }, body: fd }); const json = await res.json(); alert('Imported '+json.imported+' records'); await renderFilters(); await renderEmployees(); } catch(e){ alert('CSV import failed: '+e); }
                    } else {
                        // parse CSV locally
                        const text = await file.text();
                        try { const rows = CSVtoJSON(text); const list = await loadEmployees(); const merged = list.concat(rows.map(r=>({ ...r, id: Date.now()+Math.random()*10000 }))); await saveEmployees(merged); alert('Imported '+rows.length+' records locally'); await renderFilters(); await renderEmployees(); } catch(e){ alert('CSV parse failed: '+e); }
                    }
                });
                document.getElementById('importSampleBtn').insertAdjacentElement('afterend', csvBtn);
            }
        }

        // simple CSV parser to object array (expects columns: name,mobile,email,state,district,taluka,village,role)
        function CSVtoJSON(csv){
            const lines = csv.split(/\r?\n/).filter(Boolean);
            const hdr = lines.shift().split(',').map(h=>h.trim());
            return lines.map(l=>{ const cols = l.split(','); const obj = {}; hdr.forEach((h,i)=> obj[h]= (cols[i]||'').trim()); return obj; });
        }

        async function onAddEmployee(e){
            e.preventDefault();
            const emp = { name: document.getElementById('e_name').value.trim(), mobile: document.getElementById('e_mobile').value.trim(), email: document.getElementById('e_email').value.trim(), state: document.getElementById('e_state').value.trim(), district: document.getElementById('e_district').value.trim(), taluka: document.getElementById('e_taluka').value.trim(), village: document.getElementById('e_village').value.trim(), role: document.getElementById('e_role').value.trim() };
            if (!emp.name) { alert('Name required'); return; }
            const token = getToken();
            if (token) {
                try { await apiFetch('/api/employees', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(emp) }); } catch(err){ alert('API add failed: '+err); }
            } else {
                const list = await loadEmployees(); list.push({ id: Date.now(), ...emp }); await saveEmployees(list);
            }
            clearForm(); await renderFilters(); await renderEmployees();
        }

        async function importSample(){
            try{
                const sample = await (await fetch('assets/data/sample-employees.json')).json();
                const token = getToken();
                if (token) {
                    await apiFetch('/api/employees/import', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(sample) });
                    alert('Imported sample to server');
                } else {
                    const list = await loadEmployees(); const merged = list.concat(sample.map(s=>({ ...s, id: Date.now()+Math.random()*10000 }))); await saveEmployees(merged); alert('Imported sample locally');
                }
                await renderFilters(); await renderEmployees();
            } catch(e){ alert('Import failed: '+e); }
        }

        async function exportEmployees(){
            const token = getToken();
            if (token) {
                try { const data = await apiFetch('/api/employees/export'); const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='employees.json'; a.click(); URL.revokeObjectURL(url); } catch(e){ alert('Export failed: '+e); }
            } else {
                const list = await loadEmployees(); const blob = new Blob([JSON.stringify(list,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='employees.json'; a.click(); URL.revokeObjectURL(url);
            }
        }

        async function renderFilters(){
            const list = await loadEmployees();
            const states = Array.from(new Set(list.map(e=>e.state).filter(Boolean))).sort();
            const stSel = document.getElementById('filterState'); stSel.innerHTML = '<option value="">All States</option>';
            states.forEach(s=> stSel.appendChild(optionEl(s)));
            document.getElementById('filterDistrict').innerHTML = '<option value="">All Districts</option>';
            document.getElementById('filterTaluka').innerHTML = '<option value="">All Talukas</option>';
            document.getElementById('filterVillage').innerHTML = '<option value="">All Villages</option>';
            if (states.length===1) { onFilterChange(); }
        }

        async function onFilterChange(){
            const state = document.getElementById('filterState').value;
            const districtSel = document.getElementById('filterDistrict');
            const talukaSel = document.getElementById('filterTaluka');
            const villageSel = document.getElementById('filterVillage');
            const list = await loadEmployees();
            const districts = Array.from(new Set(list.filter(e=> !state || e.state===state).map(e=>e.district).filter(Boolean))).sort();
            districtSel.innerHTML = '<option value="">All Districts</option>'; districts.forEach(d=> districtSel.appendChild(optionEl(d)));
            const district = districtSel.value;
            const talukas = Array.from(new Set(list.filter(e=> (!state || e.state===state) && (!district || e.district===district)).map(e=>e.taluka).filter(Boolean))).sort();
            talukaSel.innerHTML = '<option value="">All Talukas</option>'; talukas.forEach(t=> talukaSel.appendChild(optionEl(t)));
            const taluka = talukaSel.value;
            const villages = Array.from(new Set(list.filter(e=> (!state || e.state===state) && (!district || e.district===district) && (!taluka || e.taluka===taluka)).map(e=>e.village).filter(Boolean))).sort();
            villageSel.innerHTML = '<option value="">All Villages</option>'; villages.forEach(v=> villageSel.appendChild(optionEl(v)));
            await renderEmployees();
        }

        async function resetFilters(){ ['filterState','filterDistrict','filterTaluka','filterVillage'].forEach(id=>document.getElementById(id).value=''); await renderFilters(); await renderEmployees(); }

        function optionEl(val) { const o = document.createElement('option'); o.value = val; o.text = val; return o; }

        async function renderEmployees(){
            const container = document.getElementById('employeesContainer');
            const list = await loadEmployees();
            const state = document.getElementById('filterState').value;
            const district = document.getElementById('filterDistrict').value;
            const taluka = document.getElementById('filterTaluka').value;
            const village = document.getElementById('filterVillage').value;
            let filtered = list.filter(e=> (!state || e.state===state) && (!district || e.district===district) && (!taluka || e.taluka===taluka) && (!village || e.village===village));
            const grouped = {};
            filtered.forEach(emp=>{ const t = emp.taluka || '—'; const v = emp.village || '—'; grouped[t] = grouped[t]||{}; grouped[t][v] = grouped[t][v]||[]; grouped[t][v].push(emp); });
            container.innerHTML = '';
            if (!filtered.length) { container.innerHTML = '<p class="text-slate-400">No employees found.</p>'; return; }
            Object.keys(grouped).sort().forEach(talukaKey=>{
                const talukaWrap = document.createElement('div'); talukaWrap.className = 'border border-slate-800 p-3 rounded';
                const h = document.createElement('h3'); h.className='font-bold text-lg'; h.textContent = 'Taluka: ' + talukaKey; talukaWrap.appendChild(h);
                Object.keys(grouped[talukaKey]).sort().forEach(villageKey=>{
                    const vTitle = document.createElement('h4'); vTitle.className='font-semibold mt-2'; vTitle.textContent = 'Village: ' + villageKey; talukaWrap.appendChild(vTitle);
                    const listEl = document.createElement('div'); listEl.className='mt-1 grid md:grid-cols-2 gap-2';
                    grouped[talukaKey][villageKey].forEach(emp=>{
                        const card = document.createElement('div'); card.className='p-3 bg-slate-900 rounded flex justify-between items-start';
                        const left = document.createElement('div'); left.innerHTML = `<div class="font-bold">${escapeHtml(emp.name)}</div><div class="text-xs text-slate-400">${escapeHtml(emp.role||'')}</div><div class="text-xs text-slate-400">${escapeHtml(emp.mobile||'')} • ${escapeHtml(emp.email||'')}</div>`;
                        const right = document.createElement('div'); right.innerHTML = `<div class="flex flex-col space-y-1"><button class="text-xs px-2 py-1 bg-yellow-600 rounded" onclick="onEdit(${emp.id})">Edit</button><button class="text-xs px-2 py-1 bg-red-600 rounded" onclick="onDelete(${emp.id})">Delete</button></div>`;
                        card.appendChild(left); card.appendChild(right); listEl.appendChild(card);
                    }); talukaWrap.appendChild(listEl);
                }); container.appendChild(talukaWrap);
            });
        }

        function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        async function onEdit(id) {
            const list = await loadEmployees();
            const e = list.find(x=>x.id===id);
            if (!e) return;
            document.getElementById('e_name').value = e.name;
            document.getElementById('e_mobile').value = e.mobile;
            document.getElementById('e_email').value = e.email;
            document.getElementById('e_state').value = e.state;
            document.getElementById('e_district').value = e.district;
            document.getElementById('e_taluka').value = e.taluka;
            document.getElementById('e_village').value = e.village;
            document.getElementById('e_role').value = e.role;
            const btn = document.getElementById('addEmployeeBtn'); btn.textContent = 'Save';
            btn.removeEventListener('click', onAddEmployee);
            btn.addEventListener('click', async function saveEdit(ev){ ev.preventDefault();
                const token = getToken();
                if (token) {
                    try {
                        await apiFetch('/api/employees/'+id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: document.getElementById('e_name').value.trim(), mobile: document.getElementById('e_mobile').value.trim(), email: document.getElementById('e_email').value.trim(), state: document.getElementById('e_state').value.trim(), district: document.getElementById('e_district').value.trim(), taluka: document.getElementById('e_taluka').value.trim(), village: document.getElementById('e_village').value.trim(), role: document.getElementById('e_role').value.trim() }) });
                    } catch(err){ alert('Save failed: '+err); }
                } else {
                    const list2 = await loadEmployees(); const obj = list2.find(x=>x.id===id); if (obj){ obj.name=document.getElementById('e_name').value.trim(); obj.mobile=document.getElementById('e_mobile').value.trim(); obj.email=document.getElementById('e_email').value.trim(); obj.state=document.getElementById('e_state').value.trim(); obj.district=document.getElementById('e_district').value.trim(); obj.taluka=document.getElementById('e_taluka').value.trim(); obj.village=document.getElementById('e_village').value.trim(); obj.role=document.getElementById('e_role').value.trim(); await saveEmployees(list2); }
                }
                btn.textContent = 'Add Employee'; btn.removeEventListener('click', saveEdit); btn.addEventListener('click', onAddEmployee); clearForm(); await renderFilters(); await renderEmployees();
            });
        }

        async function onDelete(id) {
            if (!confirm('Delete this employee?')) return;
            const token = getToken();
            if (token) {
                try { await apiFetch('/api/employees/'+id, { method:'DELETE' }); } catch(e){ alert('Delete failed: '+e); }
            } else {
                let list = await loadEmployees(); list = list.filter(e=> e.id !== id); await saveEmployees(list);
            }
            await renderFilters(); await renderEmployees();
        }

        // if already logged in (token present) show admin
        if (getToken()) showAdminUI();
    </script>
</body>
</html>
